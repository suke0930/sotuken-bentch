# Front Driver - システム仕様書

`express-session`を使用したセキュアなセッション管理システムです。このドキュメントは、特に初心者エンジニアがWebアプリケーションの認証の仕組みを理解するため教材となることを目指しています。

## 🎯 このシステムの目的

このシステムは、Webサイトで「ログインしている人だけが見れるページ」を実現するための基本的な仕組み（セッション管理と認証）を提供します。安全なWebアプリケーションを作る上で欠かせない、以下の要素を学ぶことができます。

- **セッション管理**: ユーザーがログイン状態を維持する仕組み
- **認証**: ユーザーが「本人である」ことを確認するプロセス
- **セキュリティ**: 不正なアクセスからユーザーとシステムを守るための基本的な対策

## 🛠️ 使用技術とアーキテクチャ

このシステムは、大きく分けて「フロントエンド（ブラウザ側）」と「バックエンド（サーバー側）」で構成されています。

### アーキテクチャ概要

```
  [ブラウザ (フロントエンド)]                           [サーバー (バックエンド)]
 (index.html, demo.html)                               (Node.js + Express)

      │                                                       │
 1.   ├─ GET / (ログインページ表示) ──────────────────────────> │
      │ <────────────────────────────────────────── HTMLを返す │
      │                                                       │
 2.   ├─ POST /user/login (devidを送信) ──────────────────────> │
      │                                                       │  (1) devidをusers.jsonで検証
      │                                                       │  (2) 認証成功ならセッション作成
      │                                                       │
      │ <─── (Set-Cookieヘッダ & 成功JSON) ─────────────────── │
      │                                                       │
 3.   ├─ GET /demo (Cookieを付けてリクエスト) ────────────────> │
      │                                                       │  (1) Cookieを検証しセッション復元
      │                                                       │  (2) 認証済みかチェック
      │                                                       │
      │ <────────────────────────────────────────── HTMLを返す │

```

### 主要技術

- **バックエンド (index.ts)**
  - **Node.js**: JavaScriptをサーバーサイドで動かすための環境です。
  - **Express**: Node.jsでWebサーバーを簡単に作るためのフレームワークです。ルーティング（URLごとの処理の振り分け）などを担当します。
  - **express-session**: Expressでセッション管理を簡単かつ安全に実装するためのライブラリです。ログイン状態の保持に使います。
  - **TypeScript**: JavaScriptに「型」の概念を追加した言語です。コードの品質と安全性を高めます。

- **フロントエンド (web/*.html)**
  - **HTML/CSS**: Webページの骨格とデザインを作ります。
  - **JavaScript (Fetch API)**: サーバーと通信（APIを呼び出す）するために使用します。ログインやログアウト処理を非同期で行います。

## 🔑 認証とセッション管理の仕組み

このシステムの中核となる「どうやってログイン状態を覚えているのか？」を解説します。

### 1. ユーザー識別子 `devid`

- **役割**: ユーザー（正確にはブラウザ）を識別するための一意なIDです。
- **生成**: ユーザーが初めてログインページにアクセスした際、フロントエンドのJavaScriptが`crypto.randomUUID()`を使って生成し、ブラウザの`localStorage`に保存します。
- **認証**: ログイン時に、この`devid`がサーバーに登録された許可リスト(`devsecret/users.json`)に含まれているかを確認します。

### 2. セッション管理フロー

1.  **ログイン試行**:
    - ユーザーがログインボタンを押すと、フロントエンドは`devid`を付けてサーバーの`/user/login`エンドポイントにリクエストを送ります。

2.  **サーバーでの認証とセッション生成**:
    - サーバーは受け取った`devid`が有効かチェックします。
    - 認証に成功すると、`express-session`が新しいセッションを作成し、一意な**セッションID**を生成します。
    - サーバーは「このセッションIDは、このユーザー(`devid`)のものです」という情報をサーバー内のメモリ（または本番環境ではデータベース）に保存します。
    - そして、HTTPレスポンスの`Set-Cookie`ヘッダーを使って、生成したセッションIDをブラウザに送り返します。

3.  **ブラウザでのCookie保存**:
    - ブラウザはサーバーから受け取ったセッションIDを**Cookie**として保存します。
    - このCookieには`HttpOnly`属性が付いているため、JavaScriptから読み取ることはできず、XSS攻撃のリスクを低減します。

4.  **認証後のリクエスト**:
    - ユーザーがデモページ(`/demo`)など、認証が必要なページにアクセスしようとすると、ブラウザは**自動的に**保存しているCookie（セッションID）をリクエストに含めてサーバーに送ります。

5.  **サーバーでのセッション検証**:
    - サーバーは受け取ったCookieのセッションIDを元に、サーバー内に保存しているセッション情報を探します。
    - 対応するセッション情報が見つかれば、「このユーザーは認証済みだ」と判断し、要求されたページ（`demo.html`）を返します。
    - もしセッションIDが無効だったり、セッション情報が見つからなければ、「認証されていない」と判断し、エラーを返します。

6.  **ログアウト**:
    - ユーザーがログアウトすると、サーバーはセッション情報を破棄し、ブラウザにCookieを削除するよう指示します。これにより、ログイン状態は解除されます。

この仕組みにより、ユーザーは一度ログインすれば、ブラウザを閉じるまで（またはセッションの有効期限が切れるまで）ログイン状態を維持できます。

## 🔧 API エンドポイント仕様

### 認証・セッション関連

- `POST /user/login` - ログイン処理
   - **リクエストボディ**: `{ "devid": "..." }`
   - **動作**:
     1. リクエストから`devid`を取得します。
     2. `devsecret/users.json`に`devid`が存在するか検証します。
     3. 認証に成功すると、`req.session`にユーザー情報（`devid`, `loginAt`）を保存します。これによりセッションが確立されます。
     4. 成功レスポンスと、セッションIDを含む`Set-Cookie`ヘッダーを返します。
   - **レスポンス (成功時)**: `200 OK` `{ "ok": true, "message": "...", "devid": "..." }`
   - **レスポンス (失敗時)**: `401 Unauthorized` `{ "ok": false, "reason": "forbidden_devid", ... }`

- `GET /user/auth` - セッション状態確認
   - **動作**:
     1. リクエストに付随するCookieを元に、`express-session`がセッション情報を復元します。
     2. `req.session.devid`が存在するかどうかで、ユーザーが認証済みか判断します。
     3. 認証済みであれば、セッション情報を返します。
   - **レスポンス (認証済み)**: `200 OK` `{ "ok": true, "devid": "...", "loginAt": "..." }`
   - **レスポンス (未認証)**: `401 Unauthorized` `{ "ok": false, "reason": "invalid_session", ... }`

- `POST /user/logout` - ログアウト処理
   - **動作**:
     1. `req.session.destroy()`を呼び出し、サーバー側のセッション情報を破棄します。
     2. ブラウザにセッションCookieを削除するよう指示するヘッダーを返します。
   - **レスポンス**: `200 OK` `{ "ok": true, "message": "ログアウトしました" }`

### ページ・コンテンツ関連

- `GET /` - ログインページ
   - `web/index.html`を返します。認証は不要です。

- `GET /demo` - 認証必須デモページ（認証ミドルウェア使用）
   - **認証ミドルウェア (`authMiddleware`)**: このエンドポイントにアクセスがあると、まず認証ミドルウェアが動作します。`req.session.devid`の有無をチェックし、存在しない場合は`401 Unauthorized`エラーを返して処理を中断します。
   - 認証済みの場合は、`web/demo.html`を返します。

- `GET /api/protected` - 認証必須APIの例
   - `/demo`と同様に、`authMiddleware`によって保護されています。
   - 認証済みのユーザーのみがこのAPIからデータを取得できます。

## 🔐 セキュリティ機能

### 実装済みセキュリティ対策

- **express-session**: 堅牢なセッション管理
- **HTTPOnly Cookie**: XSS攻撃を防ぐCookie設定
- **SameSite設定**: CSRF攻撃を防ぐ（開発環境: `lax`）
- **セッション有効期限**: 24時間の自動タイムアウト
- **セキュリティヘッダー**: 基本的なセキュリティヘッダーを設定
- **入力検証**: 適切なバリデーション処理

### 本番環境用設定（推奨）

`index.ts`内には本番環境向けの推奨設定がコメントとして記載されています。本番環境で運用する際は、これらの設定を有効にすることを強く推奨します。

```typescript
// 本番環境用設定
store: new MongoStore({ // セッション情報をDBに永続化
    mongoUrl: process.env.MONGODB_URI,
    touchAfter: 24 * 3600 // 24時間ごとにセッションを更新
}),
cookie: {
    secure: true,        // HTTPS通信でのみCookieを送信
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000,
    sameSite: 'strict'   // より厳格なCSRF保護
}
```

## 🚀 使用方法

### 1. 依存関係のインストール

```bash
npm install
```

### 2. TypeScriptのコンパイルとサーバー起動

```bash
npm run dev
```

### 3. アクセス

ブラウザで `http://localhost:12800` にアクセスしてください。

## ⚠️ 注意事項

- 現在は**開発環境用**の設定です。
- 本番環境では必ず以下を実施してください：
  - HTTPS の使用
  - セッションストアをMongoDBなどに変更
  - セキュリティヘッダーの強化
  - 環境変数での設定管理
  - ログ・監視システムの導入